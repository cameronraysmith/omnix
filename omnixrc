# -*- mode: sh -*-
# shellcheck shell=bash


use_omnix() {
  : "${OMNIX_BIN:="nix --accept-flake-config --option builders '' -j0 run github:juspay/omnix --"}"
  echo "Invoking omnix using: ${OMNIX_BIN}"

  # Fetch omnix only through binary cache
  # Hence `-j0`, as well as `--option builders ''` for when there are remote builders.
  ${OMNIX_BIN} develop --stage=pre-shell $* || exit 1

  use flake ${*:-.} --accept-flake-config

  if [[ ! -z "${NIX_DIRENV_DID_FALLBACK:-}" ]]; then
    # Nix shell failed; move on!
    exit
  else
    ${OMNIX_BIN} develop --stage=post-shell $*
  fi
}
